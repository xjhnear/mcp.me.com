<!--{%extends "base-layout.twig"%}-->
<!--{%block main_content%}-->
<link href="/static/css/app.css" rel="stylesheet" type="text/css"/>
<div class="row-fluid">
    <div class="span12">
		<div class="box">

			<div class="box-title">
				<h3>任务信息</h3>
			</div>
			<div class="box-content">
			    <form id="activity-task" action="<!--{{url('a_activity2/task/task-chain-save')}}-->" method="POST" class='form-horizontal form-validate' enctype="multipart/form-data">
				<div class="control-group">
					<label class="control-label">*标题</label>
					<div class="controls">
						<input type="text" name="title" class="input-xxlarge" value="<!--{{atask.taskName}}-->" data-rule-required="true" data-msg-required="标题不能为空"  />
					</div>
				</div>

                <div class="control-group">
                    <label class="control-label">*版本限制</label>
                    <div class="controls">
                        <!--{{form_select('appVersion',appVersion,atask.appVersion,{'id':'appVersion'})}}-->
                    </div>
                </div>

                    <div class="control-group">
                        <label class="control-label">*icon</label>
                        <div class="controls">
                            <div data-provides="fileupload" class="fileupload fileupload-new">
                                <div style="max-width: 60px; max-height: 60px;" class="fileupload-new thumbnail">
                                    <img id="selected_game_icon" src="<!--{{atask.taskIcon|default('/static/img/wu_ss.gif')}}-->">
                                </div>
                                <div style="max-width: 60px; max-height: 60px; line-height: 20px;" class="fileupload-preview fileupload-exists thumbnail"></div>
							<span class="btn btn-file"><i class="icon-picture"></i>
								<span class="fileupload-new">选择照片</span><span class="fileupload-exists">Change</span>
                                <input id="task_img" name="task_img" type="hidden" value="<!--{{atask.taskIcon}}-->"/>
								<input type="file"  name="task_icon" >
							</span>
                                <a data-dismiss="fileupload" class="btn fileupload-exists" href="#">Remove</a>
                                <span style="color: rgb(185, 74, 72);" class="img_note" hidden="hidden">图片不能为空且限于png,gif,jpeg,jpg格式</span>
                            </div>
                        </div>
                    </div>
                <div class='control-group'>
                    <label class='control-label'>*类型</label>
                    <div class='controls'>
                        <!--{{form_select('task_type',task_types,atask.lineType,{'class':'sel_prize'})}}-->
                    </div>
                </div>

                <div class="row-fluid">
                    <div class="span4">
                        <div class="control-group">
                            <label class="control-label">开始时间</label>
                            <div class="controls">
                                <div class="input-append date">
                                    <input name="start_time" type="text" class="input-medium"  data-rule-required="true" data-msg-required="开始时间不能为空"  onclick="laydate({istime: true, format: 'YYYY-MM-DD hh:mm:ss'})"  value="<!--{{atask.startTime}}-->" >
                                    <span class="add-on"><i class="icon-calendar"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="span4">
                        <div class="control-group">
                            <label class="control-label">结束时间</label>
                            <div class="controls">
                                <div class="input-append date">
                                    <input name="end_time" type="text" class="input-medium " data-rule-required="true" data-msg-required="结束时间不能为空" onclick="laydate({istime: true, format: 'YYYY-MM-DD hh:mm:ss'})" value="<!--{{atask.endTime}}-->" >
                                    <span class="add-on"><i class="icon-calendar"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label">*任务排序</label>
                    <div class="controls">
                        <input type="text" name="sort" class="input-small" value="<!--{{atask.sort|default('50')}}-->" />
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label">*是否预告</label>
                    <div class="controls">
                        <label class="radio inline"><!--{{form_radio('forenotice','true',atask.forenotice=="1")}}-->是</label>
                        <label class="radio inline"><!--{{form_radio('forenotice','false',atask.forenotice=="")}}-->否</label>
                    </div>
                </div>


                <div class="control-group">
                    <label for="textfield" class="control-label">*任务内容</label>
                    <div class="controls">
                        <script id="container" name="content" type="text/plain"><!--{{atask.taskDesc}}--></script>
                    </div>
                </div>

                <div class="control-group task_children" >
                    <div class="control-group">
                        <label class="control-label">子任务选择</label>
                        <div class="controls">
                            <div style="margin-top: -8px" class="block__list block__list_words">
                                <ul id="editable" style="border: 1px solid;width: 400px;">
                                    <!--{%for item in task_children%}-->
                                    <li taskid="" starttime="<!--{{item.startTime}}-->" endtime="<!--{{item.endTime}}-->"><!--{{item.taskName}}--></li>
                                    <!--{%endfor%}-->
                                </ul>
                            </div>
                            <input type="button" id="show_iframe" value="添加子任务" class="select-task-code"/>
                        </div>
                    </div>
                </div>


			    <div class="form-actions">
					<button type="submit" class="btn btn-primary sub"><i class="icon-ok"></i>保存</button>
                    <input type="hidden" name="id" value="<!--{{id}}-->"/>
                    <input type="hidden" name="subTaskIds" class="ids" value=""/>

				</div> 
			    </form>
			</div>
		</div>
    </div>
</div>
<!--{%endblock%}-->
<!--{%block footer_js%}-->
<script src="/static/js/ajaxfileupload.js"></script>
<script src="<!--{{asset('/static/js/ueditor/ueditor.config.js')}}-->"></script>
<script src="<!--{{asset('/static/js/ueditor/ueditor.all.js')}}-->"></script>
<script src="<!--{{asset('/static/js/ueditor/lang/zh-cn/zh-cn.js')}}-->"></script>
<script src="/static/js/laydate/laydate.js"></script>
<script src="/static/js/jquery.validationEngine.js"></script>
<script src="/static/js/jquery.validationEngine-en.js"></script>
<script src="/static/js/Sortable.js"></script>
<script>

$(function() {
    var editor = UE.getEditor('container');
    $('input.datetimepicker').datetimepicker({format: 'Y-m-d H:i:s', lang: 'ch'});
    //选择子任务
    $(".select-task-code").live('click',function(){
        $.ajax({
            url:'/a_activity2/task/iframe-children-task',
            dataType:'json',
            success:function(json){
                var html = json.html;
                $.dialog({id:'pop-task-list',title:'提示',padding:2,content:html,width:650,height:500});
            }
        });
    })
    
    //提交时限制图片为空
   $(".sub").click(function() {
        var check = "true";
        $("input[name='prize_pic[]']").each(function(){
            var img = $(this).val();

            var old_img = $(this).siblings("input[name='prize_img[]']").val();
            if(!img&&!old_img){
                $(this).parent().siblings(".img_note").show();
                check = "false";
            }else{
                $(this).parent().siblings(".img_note").hide();
            }
        })

        $("input[name='youb_num[]']").each(function(){
            var num = $(this).val();
            var new_num = parseInt(num*100)/100;
            if(num!=new_num){
                $(this).val(new_num);
                if(!confirm("金额只能只能精确到分，多余部分将自动筛除")){
                    check = "false";
                }
            }
        })

        if(!$("input[name='task_icon']").val()&&!$("#task_img").val()){
            $("#task_img").parent().siblings(".img_note").show();
            check = "false";
        }else{
            $("#task_img").parent().siblings(".img_note").hide();
        }
        if(check=="false"){
            return false;
        }
    }) 
    
    
 
    $(".sub").click(function() {
        var ids = "";
        $("#editable").children("li").each(function(){
            var taskId = $(this).attr("taskId");
            if(taskId){

            ids +=taskId+",";
            var startTime1 = $(this).attr("startTime");
            startTime1 = startTime1.replace(/-/g,"/");
            startTime1 = new Date(Date.parse(startTime1));

            var endTime1 = $(this).attr("endTime");
            endTime1 = endTime1.replace(/-/g,"/");
            endTime1 = new Date(Date.parse(endTime1));
            if($(this).next("li").html()){
                var startTime2 = $(this).next("li").attr("startTime");
                startTime2 = startTime2.replace(/-/g,"/");
                startTime2 = new Date(Date.parse(startTime2));
                var endTime2 = $(this).next("li").attr("endTime"); 
               endTime2 = endTime2.replace(/-/g,"/");
                endTime2 = new Date(Date.parse(endTime2));
                //比较开始和结束时间的大小---
//                if(!(startTime1<startTime2&&endTime1<endTime2)){
//                    alert("子任务排序错误");
//                    return false;
//                }
            }
            }
        });
        $(".ids").val(ids);
//        return false;
    })
})

//var el = document.getElementById('editable');
//new Sortable(el);
$(".js-remove").live('click',function(){
    $(this).parent().remove();
})


</script>
<!--{%endblock%}-->