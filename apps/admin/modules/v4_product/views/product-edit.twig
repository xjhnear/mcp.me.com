<!--{%extends "sub-layout-shop.twig"%}-->
<!--{%block main_content%}-->
<div class="row-fluid">
	<div class="span12">
		<div class="box">
			<div class="box-title">
				<h3><i class="icon-edit"></i>编辑商品</h3>
			</div>
			<div class="box-content">
				<form id="form-product" action="<!--{{url('v4product/goods/product-edit')}}-->" method="POST" class='form-horizontal form-validate' enctype="multipart/form-data" >
					<input type="hidden" name="productCode" value="<!--{{ info.productCode }}-->">
                    <div class="row-fluid">
                        <div class="span3">
                            <div class="control-group">
                                <label class="control-label">商城类型</label>
                                <div class="controls">
                                    <!--{{form_radio('currencyType',0,info.currencyType==0)}}-->游币商城
                                </div>
                            </div>
                        </div>
                        <div class="span3">
                            <div class="control-group">
                                <div class="controls">
                                    <!--{{form_radio('currencyType',1,info.currencyType==1)}}-->钻石商城
                                </div>
                            </div>
                        </div>
                    </div>
					<div class="control-group">
						<label class="control-label">商品名称</label>
						<div class="controls">
							<input type="text" name="product_name" id="name" data-rule-required="true" data-msg-required="请填写商品名称"
							       class="input-large" value="<!--{{ info.productName }}-->"/>
						</div>
					</div>
					<div class="control-group">
						<label class="control-label">关联游戏</label>
						<div class="controls">
							<div class="input-append">
								<input id="selected_game_id" name="game_id" type="hidden" value="<!--{{ game.gid }}-->"/>
								<input id="selected_game_id" name="old_game_id" type="hidden" value="<!--{{ game.gid }}-->"/>
								<input type="text" readonly id="selected_game_name" name="game_name" class="input-medium" value="<!--{{ game.shortgname }}-->" />
								<span class="add-on select-pop-game">选择游戏</span>
							</div>
						</div>
					</div>
					<div class="control-group">
						<label for="textfield" class="control-label">商品种类</label>
						<div class="controls">
							<div class="input-append">
								<input id="selected_categoryId" name="category_id" type="hidden" value="<!--{{ info.category.categoryId }}-->" />
								<input type="text" id="selected_cate_name" name="cate_name" readonly  class="input-medium" value="<!--{{ info.category.categoryName }}-->"
								       data-rule-required="true" data-msg-required="请选择商品种类" />
								<span class="add-on select-pop-cate">选择商品种类</span>
							</div>
						</div>
					</div>

                    <div class="control-group">
                        <label for="textfield" class="control-label">商品标签</label>
                        <div class="controls">
                            <div class="input-append">
                                <input id="selected_labelId" name="label_id" type="hidden" value="<!--{{info.label_id}}-->" />
                                <input type="text" readonly id="selected_label_name"    class="input-large" name="label_name" value="<!--{{info.label_name}}-->"  />
                                <span class="add-on select-pop-label">选择商品标签</span>
                                <span class="add-on select-pop-close">清空商品标签</span>
                            </div>
                        </div>
                    </div>

                    <!--
                    <div class="control-group">
                        <label class="control-label">商品标签</label>
                        <div class="controls">
                            <div class="span9"><input type="text" name="label_name" id="tag" class="tagsinput" value=""></div>
                        </div>
                    </div>
                     -->
                    <div class="control-group" id="templateId"  >
                        <label class="control-label">商城订单模版</label>
                        <div class="controls">
                            <div class="input-append">
                                <input id="selected_templateId" name="templateId" type="hidden" value="<!--{{info.templateId}}-->" />
                                <input type="text" id="selected_templateName" readonly  class="input-xlarge" value="<!--{{info.templateName}}-->" data-rule-required="true" data-msg-required="请选择模版" />
                                <span class="add-on select-templateId">选择模版（卡密类商品不需要模版）</span>
                            </div>
                        </div>
                    </div>
					<div class="control-group">
						<label class="control-label">商品类型</label>
						<div class="controls">
							<input type="hidden" name="product_type" value="<!--{{info.productType}}-->">
							<input type="hidden" name="card_code" value="<!--{{info.cardCode}}-->">
							
							 <!--{% if info.productType == 1 %}-->
                                    实物奖品
                             <!--{% elseif  info.productType == 3 %}-->
                             		淘宝商品
                              <!--{% elseif  info.productType == 4 %}-->
                             		虚拟商品
                             <!--{% else %}-->
                                    卡密类产品
                             <!--{% endif %}-->
						</div>
					</div>
                    <div class="row-fluid">
                        <div class="span3">
                            <div class="control-group">
                                <label class="control-label">限购类型</label>
                                <div class="controls">
                                    <!--{{form_radio('lightDelivery',0,info.lightDelivery==0)}}-->手工发放
                                </div>
                            </div>
                        </div>
                        <div class="span3">
                            <div class="control-group">
                                <div class="controls">
                                    <!--{{form_radio('lightDelivery',1,info.lightDelivery==1)}}-->自动发放
                                </div>
                            </div>
                        </div>

                    </div>
					<div class="control-group taobao"<!--{% if info.productType != 3 %}-->style="display:none;"<!--{% endif %}--> >
						<label class="control-label">淘宝url</label>
						<div class="controls">
							<input type="text" name="sp_url" id="tb-url" class="input-large validate[condRequired[p-taobao]]" value="<!--{{ info.spUrl }}-->" />
						</div>
					</div>
					
					<div class="row-fluid">
						<div class="span3">
							<div class="control-group">
								<label class="control-label">限购类型</label>
								<div class="controls">
									<!--{{form_radio('limit_type',-1,info.limitType==-1)}}-->限购一个
								</div>
							</div>
						</div>
						<div class="span3">
							<div class="control-group">
								<div class="controls">
									<!--{{form_radio('limit_type',0,info.limitType==0)}}-->不限购买
								</div>
							</div>
						</div>
						<div class="span3">
							<div class="control-group">
								<div class="controls">
									<!--{{form_radio('limit_type',1,info.limitType==1,{'id':'limit'})}}-->按规则限购
								</div>
							</div>
						</div>
					</div>

					<div class="control-group limit">
						<label class="control-label">限购规则设定</label>
						<div class="controls">
							<input name="limit[]" type="checkbox" id="mr-count" value="1" <!--{{ info.singleLimit ? 'checked' : '' }}-->/> 限制每人可购买总数
							<input type="text"  <!--{% if info.singleLimit %}--> data-rule-digits="true" class="validate[condRequired[mr-count]]"
							       data-msg-digits="请填写整数" data-rule-min="2" data-msg-min="总数至少为2"<!--{% endif %}-->
                            name="single_limit" id="single-limit" style="width:50px" value="<!--{{ info.singleLimit }}-->"> 个
						</div>
					</div>
					<div class="row-fluid">
						<div class="span5 limit">
							<div class="control-group">
								<div class="controls">
									<input name="limit[]" type="checkbox" id="mt-count" value="2" <!--{{ info.ruleLimit ? 'checked' : '' }}-->/> 限制每人每

									<input type="text" name="time_value" id="time_value" <!--{% if info.ruleLimit %}--> data-rule-digits="true" data-rule-min="1" data-msg-min="最小为1"
									       class="daily-limit-1 validate[condRequired[mt-count]]" data-msg-digits="请填写整数"<!--{% endif %}-->
									       style="width:30px" value='<!--{{ info.timeValue }}-->'>
									<select name="time_type" id="time_type" style="width:80px" >
										<option value="day" <!--{{ info.timeType=='day' ? 'selected' : '' }}-->>天</option>
										<option value="hour"  <!--{{ info.timeType=='hour' ? 'selected' : '' }}-->>小时</option>
									</select>
								</div>
							</div>
						</div>
						<div class="span4 limit">
							<div class="control-group">
								<div class="controls">
									可购买数 <input type="text" name="rule_limit" id="rule_limit" <!--{% if info.ruleLimit %}--> data-rule-digits="true" data-rule-min="1" data-msg-min="最小为1" data-msg-digits="请填写整数" class="daily-limit-2 validate[condRequired[mt-count]] input-small" <!--{% endif %}--> value="<!--{{ info.ruleLimit }}-->" style="width:30px;"> 个
								</div>
							</div>
						</div>
					</div>

					<div class="control-group" id="gameRmb" >
						<label class="control-label">游币／钻石价格</label>
						<div class="controls">
							<input type="text" name="discount_game_price" id="discount_game_price" class="input-large" value="<!--{{ info.discountGamePrice }}-->"
							       data-rule-required="true"  data-msg-required="请填写游币／钻石价格" data-rule-digits="true"  data-msg-digits="请填写整数" />(如果有优惠此处填写为折扣后的价格)
						</div>
					</div>
					<div class="row-fluid">
						<div class="span3">
							<div class="control-group">
								<label class="control-label">限时优惠</label>
								<div class="controls">
									<input id="if-discount" name="product_display" data-on-color="success" data-on-text="优惠" data-off-color="danger" data-off-text="无" class="switchbox" type="checkbox" <!--{{ info.productDisplay ? 'checked' : '' }}-->/>
								</div>
							</div>
						</div>
						<div class="span3">
							<div id="discount-price" class="control-group discount-price">
								<label class="control-label">折扣</label>
								<div class="controls">
									<input type="text" id="dis-price" name="product_game_price"  class="input-small validate[condRequired[if-discount]]" data-rule-digits="true" data-rule-min="1" data-rule-max="100" data-msg-min="最小为1" data-msg-max="最大为100" data-msg-digits="请填写整数"     value="<!--{{ info.productGamePrice }}-->" />%
								</div>
							</div>
						</div>
					</div>
					<div class="control-group" id="biaoqianType" >
							<label class="control-label">商品标签</label>
							<div class="controls">
								<!--{{form_radio('biaoqianType',0,info.biaoqianType==0)}}-->没有
								&nbsp&nbsp
								<!--{{form_radio('biaoqianType',1,info.biaoqianType==1)}}-->折扣
								&nbsp&nbsp<!--{{form_radio('biaoqianType',2,info.biaoqianType==2)}}-->最新
								&nbsp&nbsp<!--{{form_radio('biaoqianType',3,info.biaoqianType==3)}}-->最热
								&nbsp&nbsp<!--{{form_radio('biaoqianType',4,info.biaoqianType==4)}}-->推荐
							</div>
					</div>
					
					<div class="control-group">
						<label class="control-label">是否置顶</label>
						<div class="controls">
							<input id="if-isTop" name="isTop" data-on-color="success" data-on-text="置顶"
							       data-off-color="danger" data-off-text="不置顶" class="switchbox" type="checkbox" <!--{{info.isTop ? 'checked' : '' }}-->/>
						</div>
					</div>
					<div class="row-fluid">
						<div class="span3"  >
							<div class="control-group"id="product_sort" >
								<label class="control-label">商品排序</label>
								<div class="controls">
									<input type="text" name="product_sort"  class="input-small" value="<!--{{ info.productSort }}-->" />
								</div>
							</div>
						</div>

					</div>


					<div class="row-fluid">
						<div class="span3">
							<div class="control-group">
								<label class="control-label">列表小图</label>
								<div class="controls">
									<div class="fileupload fileupload-new" data-provides="fileupload">
										<div class="fileupload-new thumbnail" style="max-width: 120px; max-height: 120px;">
											<img src="<!--{{ info.img.listPic ? info.img.listPic : '/static/img/nopic.gif' }}-->" />
										</div>
										<div class="fileupload-preview fileupload-exists thumbnail" style="max-width: 120px; max-height: 120px; line-height: 20px;"></div>
										<div>
											<span class="btn btn-file"><i class="icon-picture"></i><span class="fileupload-new">选择照片</span><span class="fileupload-exists">重新选择</span><input type="file" name='smallpic' /></span>
										</div>
									</div>
									<span class="help-inline">图片最佳尺寸:294*190</span>
									<input type="hidden" name="old_small_pic" value="<!--{{ info.img.listPic }}-->">
								</div>
							</div>
						</div>
                    </div>
                    <div class="row-fluid">
						<div class="span3">
							<div class="control-group">
								<label class="control-label">详情大图</label>
								<div class="controls">
									<div class="fileupload fileupload-new" data-provides="fileupload">
										<div class="fileupload-new thumbnail" style="max-width: 120px; max-height: 120px;">
											<img src="<!--{{info.img.detailPic?info.img.detailPic:'/static/img/nopic.gif'}}-->" />
										</div>
										<div class="fileupload-preview fileupload-exists thumbnail" style="max-width: 120px; max-height: 120px; line-height: 20px;"></div>
										<div>
											<span class="btn btn-file"><i class="icon-picture"></i><span class="fileupload-new">选择照片</span><span class="fileupload-exists">重新选择</span><input type="file" name='bigpic' /></span>
										</div>
									</div>
									<span class="help-inline">图片最佳尺寸:640*334</span>
									<input type="hidden" name="old_big_pic" value="<!--{{ info.img.detailPic }}-->" >
								</div>
							</div>
						</div>
                    </div>
					<div class="control-group">
			            <label class="control-label">使用说明</label>
			            <div class="controls">
			            	<script id="productInstruction" name="productInstruction" type="text/plain"><!--{{info.productInstruction }}--></script>
			                
			            </div>
			        </div>
                    <div class="control-group" >
                        <label class="control-label">联系我们:</label>
                        <div class="controls">
                            <input type="text" name="contactInfo"  class="input-large" value="<!--{{info.contactInfo}}-->"/>
                        </div>
                    </div>
					<div class="row-fluid">
						<div class="span4">
							<div class="control-group">
								<label class="control-label">*开始时间</label>
								<div class="controls">
									  <input name="start_time" id="date_timepicker_start" type="text" class="input-medium laydate-icon" value="<!--{{info.startTimeStr}}-->" data-rule-required="true"  data-msg-required="请填写开始时间"  readonly>
									  <span class="add-on"><i class="icon-calendar"></i></span>
								</div>
							</div>
						</div>
						<div class="span4">
							<div class="control-group">
								<label class="control-label">*结束时间</label>
								<div class="controls">
									
										<input name="end_time" id="date_timepicker_end" type="text" class="input-medium laydate-icon" value="<!--{{info.endTimeStr}}-->" data-rule-required="true"  data-msg-required="请填写结束时间" readonly>
										<span class="add-on"><i class="icon-calendar"></i></span>
									
								</div>
							</div>
						</div>
					</div>

					<div class="control-group" id="productPrice">
						<label class="control-label">是否发完自动下架</label>
						<div class="controls">
							<input id="discount" name="off_together" data-on-color="success" data-on-text="是" data-off-color="danger" data-off-text="否"
							       class="switchbox" type="checkbox" <!--{{ info.isOffTogether ? 'checked' : '' }}-->/>
						</div>
					</div>
                    <input type="hidden" name="tmp" id="tmp" value="">
                    <input type="hidden" name="filename" id="filename" value="">
					<div class="form-actions">
						<button type="submit" class="btn btn-primary"><i class="icon-ok"></i>保存</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>
<!--{%endblock%}-->
<!--{%block footer_js%}-->
<script src="/static/js/jquery.uniform.min.js"></script>
<script src="<!--{{asset('/static/js/xheditor/xheditor-1.1.14-zh-cn.min.js')}}-->"></script>
<script src="/static/js/jquery.validationEngine.js"></script>
<script src="/static/js/jquery.validationEngine-en.js"></script>
<script src="/static/js/ajaxfileupload.js"></script>
<script src="<!--{{asset('/static/js/ueditor/ueditorbbs.config.js')}}-->"></script>
<script src="<!--{{asset('/static/js/ueditor/ueditor.all.js')}}-->"></script>
<script src="/static/js/laydate/laydate.js"></script>
<link rel="stylesheet" href="/static/css/plugins/tagsinput/jquery.tagsinput.css">
<script src="<!--{{asset('/static/js/plugins/tagsinput/jquery.tagsinput.min.js')}}-->"></script>
<script src="<!--{{asset('/static/js/plugins/jquery-ui/jquery-ui-1.9.2.custom.min.js')}}-->"></script>
<script>
    $("#mt-count").on('ifChanged', function (e) {
        $("#time_value,#time_type,#rule_limit").val('').removeAttr("data-rule-digits data-rule-min data-msg-min data-msg-digits").removeClass("validate[condRequired[mt-count]]");
        if(e.currentTarget.checked==true){
            $("#time_value,#rule_limit").attr({'data-rule-digits':"true", 'data-rule-min':"1", 'data-msg-min':"最小为1",'data-msg-digits':"请填写整数"});
        }
    });
    $("#mr-count").on('ifChanged', function (e) {
        $("#single-limit").val('').removeAttr("data-rule-digits data-rule-min data-msg-min data-msg-digits").removeClass("validate[condRequired[mr-count]]");
        if(e.currentTarget.checked==true){
            $("#single-limit").attr({'data-rule-digits':"true", 'data-rule-min':"1", 'data-msg-min':"最小为1",'data-msg-digits':"请填写整数"});
        }
    });
    /***
    $('#tag').tagsInput({
        width:'auto',
        itemValue: 'id',
        itemText: 'value',
        'defaultText':'请输入标签名',
        height:'auto',
        autocomplete_url:'<!--{{url('/v4product/label/label-list-select')}}-->',

         onAddTag:function(tag){

            console.log('增加了'+tag);


        },
         onRemoveTag:function(tag){
            console.log('删除了'+tag)
        },

    });
    ***/
    $("#time_type").val("<!--{{info.timeType}}-->");

    <!--{% if info.productDisplay %}-->
            $("#biaoqianType").hide();
    <!--{% endif %}-->


    <!--{% if info.tagRelListValue %}-->
        $('#tag').importTags("<!--{{info.tagRelListValue}}-->");
    <!--{% endif %}-->
	var set_selected_game=function(game_id,game_name,icon){
		$('#selected_game_id').val(game_id);
		$('#selected_game_name').val(game_name);
	};

	var set_selected_cate = function(cate_id,cate_name){
		$("#selected_categoryId").val(cate_id);
		$("#selected_cate_name").val(cate_name);
	};

    var set_selected_label =function(id,label){
        var selected_labelId=$("#selected_labelId"),
                selected_label_name=$("#selected_label_name");
        if(selected_labelId.val()){
            selected_labelId.val(selected_labelId.val()+','+id);
            selected_label_name.val(selected_label_name.val()+','+label);
        }else{
            selected_labelId.val(id);
            selected_label_name.val(label);
        }
    }
    $("span.select-pop-close").on('click',function(){
        $("#selected_labelId,#selected_label_name").val('');
    });
    var set_selected_template = function(templateId,templateName){
        $("#selected_templateId").val(templateId);
        $("#selected_templateName").val(templateName);
    }

	function limit_fade(check_val){
		switch(check_val){
			case '-1' :
			case '0' :
				$("input[name='limit[]']").removeClass('validate[minCheckbox[1]]');
				$('.limit').fadeOut();
				break;
			case '1' :
				$("input[name='limit[]']").addClass('validate[minCheckbox[1]]');
				$('.limit').fadeIn();
		}
	}

	$(function(){
		UE.getEditor('productInstruction');
		var start = {
		    elem: '#date_timepicker_start',
		    format: 'YYYY/MM/DD hh:mm:ss',
		    min: laydate.now(), //设定最小日期为当前日期
		    max: '2099-06-16 23:59:59', //最大日期
		    istime: true,
		    istoday: false,
		    choose: function(datas){
		         end.min = datas; //开始日选好后，重置结束日的最小日期
		         end.start = datas //将结束日的初始值设定为开始日
		    }
		};
		var end = {
		    elem: '#date_timepicker_end',
		    format: 'YYYY/MM/DD hh:mm:ss',
		    min: laydate.now(),
		    max: '2099-06-16 23:59:59',
		    istime: true,
		    istoday: false,
		    choose: function(datas){
		        start.max = datas; //结束日选好后，重置开始日的最大日期
		    }
		};
		laydate(start);
		laydate(end);
		$('input.switchbox').bootstrapSwitch();
		$('input').iCheck({
			checkboxClass: 'icheckbox_square-orange',
			radioClass: 'iradio_square-orange',
			increaseArea: '20%'
		});

		
		
		//优惠
		if($("#if-discount:checked").val()){
			$("#discount-price").show();
		}else{
			$("#discount-price").hide();
		};
		$('#if-discount').on('switchChange.bootstrapSwitch', function (e, data) {
			if(data){
				$("#discount-price").fadeIn();
                $("#biaoqianType").fadeOut();
			}else{
				$("#discount-price").fadeOut();
                $("#biaoqianType").fadeIn();
			}
		});
        //优惠
        if($("#if-isTop:checked").val()){
            $("#product_sort").hide();
        }else{
            $("#product_sort").show();
        };
        $('#if-isTop').on('switchChange.bootstrapSwitch', function (e, data) {
            if(data){
                $("#product_sort").fadeOut();
            }else{
                $("#product_sort").fadeIn();
            }
        });
		//限购
		limit_fade($("input[name='limit_type']:checked").val());
		$("input[name='limit_type']").on('ifChecked',function(e){
			var check_val = e.currentTarget.value;
			limit_fade(check_val);
		});

        $('span.select-pop-label').on('click',function(){
            $.ajax({
                url:'/v4product/label/label-list-select',
                dataType:'json',
                success:function(json){
                    var html = json.html;
                    $.dialog({id:'pop-label-list',title:'提示',padding:2,content:html,width:600,height:580});
                }
            });
        });
        $('span.select-templateId').on('click',function(){
            $.ajax({
                url:'/v4product/goods/template-select-list',
                dataType:'json',
                success:function(json){
                    var html = '';
                    html = json.html;
                    $.dialog({id:'template-select-list',title:'提示',padding:2,content:html,width:600,height:580});
                }
            });
        });


        $('.select-pop-cate').on('click',function(){
            var i=0;
            if($("input[name='currencyType']:checked").val()){
                i=$("input[name='currencyType']:checked").val();
            }
			$.ajax({
				url:'/v4product/goods/cate-list-select',
				dataType:'json',
				success:function(json){
					var html = json.html;
					$.dialog({id:'pop-cate-list',title:'提示',padding:2,content:html,width:600,height:580});
				}
			});
		});

		$('.select-pop-game').bind('click',function(){
			$.ajax({
				url:'/game/api/game-search',
				dataType:'json',
				success:function(json){
					var html = json.html;
					$.dialog({id:'pop-game-list',title:'提示',padding:2,content:html,width:600,height:580});
				}
			});
		});

		//关联验证
		jQuery("#form-product").validationEngine({'custom_error_messages':{
			"minCheckbox":{
				'message':'<span style="left:240px;top:25px;color:#b94a48; position: absolute;width: 200px;">请至少选择一个规则</span>'
			},
			"#single-limit":{
				"condRequired": {'message':'<span style="color:#b94a48;left:220px;top:-20px;position:relative;width:100px;">请填写购买总数</span>'}
			},
			"#file_upload":{
				"condRequired": {'message':'<span style="color:#b94a48;position:absolute;width:100px;">请选择卡密文件</span>'}
			},
			"#tb-url":{
				"condRequired":{'message':'<span style="color: #b94a48;position:absolute;left:48px;width:100px;">请填写淘宝URL</span>'}
			},
			".daily-limit-1":{
				"condRequired": {'message':'<span style="color:#b94a48;left:240px;top:-20px;position:relative;width:100px;">请填写限制项</span>'}
			},
			".daily-limit-2":{
				"condRequired": {'message':'<span style="color:#b94a48;left:200px;top:-25px;position:relative;width:100px;">请填写限制项</span>'}
			},
			"#dis-price":{
				"condRequired": {'message':'<span style="color:#b94a48;position:absolute;left:50px;top:5px;width:120px;">请输入优惠后价格</span>'}
			}
		}});
	});
</script>
<!--{%endblock%}-->