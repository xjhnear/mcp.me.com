<!--{%extends "sub-layout-shop.twig"%}-->
<!--{%block main_content%}-->
<div class="row-fluid">
	<div class="span12">
		<div class="box">
			<div class="box-title">
				<h3><i class="icon-edit"></i>添加商品</h3>
			</div>
			<div class="box-content">
				<form id="form-product" action="<!--{{url('v4product/goods/product-add')}}-->" method="POST" class='form-horizontal form-validate' enctype="multipart/form-data" >
					<div class="control-group">
						<label class="control-label">*商品名称</label>
						<div class="controls">
							<input type="text" name="product_name" id="name" data-rule-required="true" data-msg-required="请填写商品名称"
							       class="input-large" value="<!--{{ input_old('product_name') }}-->"/>
						</div>
					</div>
					<div class="control-group">
						<label class="control-label">关联游戏</label>
						<div class="controls">
							<div class="input-append">
								<input id="selected_game_id" name="game_id" type="hidden" value="<!--{{ input_old('game_id') }}-->"/>
								<input type="text" readonly id="selected_game_name" name="game_name" class="input-medium" value="<!--{{ input_old('game_name') }}-->" />
								<span class="add-on select-pop-game">选择游戏</span>
							</div>
						</div>
					</div>
					<div class="control-group">
						<label for="textfield" class="control-label">*商品种类</label>
						<div class="controls">
							<div class="input-append">
								<input id="selected_categoryId" name="category_id" type="hidden" value="<!--{{ input_old('category_id') }}-->" />
								<input type="text" readonly id="selected_cate_name" name="cate_name" readonly  class="input-medium" value="<!--{{ input_old('cate_name') }}-->"
								       data-rule-required="true" data-msg-required="请选择商品种类" />
								<span class="add-on select-pop-cate">选择商品种类</span>
							</div>
						</div>
					</div>

					<div class="row-fluid">
						<div class="span3">
							<div class="control-group">
								<label class="control-label">商品类型</label>
								<div class="controls">
									<!--{{form_radio('product_type',0,input_old('product_type')==0,{'id':'virtual'})}}-->卡密类产品
								</div>
							</div>
						</div>
						<div class="span3">
							<div class="control-group">
								<div class="controls">
									<!--{{form_radio('product_type',1,input_old('product_type')==1)}}-->实物
								</div>
							</div>
						</div>
						<div class="span3">
							<div class="control-group">
								<div class="controls">
									<!--{{form_radio('product_type',2,input_old('product_type')==2,{'id':'p-taobao'})}}-->淘宝商品
								</div>
							</div>
						</div>
						<div class="span3">
							<div class="control-group">
								<div class="controls">
									<!--{{form_radio('product_type',3,input_old('product_type')==2,{'id':'p-taobao'})}}-->虚拟商品
								</div>
							</div>
						</div>
					</div>

					<div class="control-group taobao">
						<label class="control-label">淘宝url</label>
						<div class="controls">
							<input type="text" name="sp_url" id="tb-url" class="input-large validate[condRequired[p-taobao]]" value="<!--{{ input_old('sp_url') }}-->" />
						</div>
					</div>

					<div class="row-fluid virtual">
						<div class="span4">
							<div class="control-group" id="card-import-time">
								<label class="control-label">*卡密过期时间</label>
								<div class="controls">
									<div class="input-append date">
										<input class="input-medium datetimepicker" id="exp_time" name="exp_time" type="text" readonly value="<!--{{ input_old('exp_time') }}-->" id="expTimeStr">
										<span class="add-on">
											<i class="icon-calendar"></i>
										</span>
									</div>
								</div>
							</div>
						</div>
						<div class="span3">
							<div class="control-group" id="card-import">
								<label class="control-label">*卡密导入</label>
								<div class="controls">
									<input class="validate[condRequired[virtual]]" name="import_file" id="file_upload" type="file">
									<span class="add-on text-error card-line"></span>
									<input type="hidden" id="card-code" name="card_code" value="<!--{{ input_old('card_code') }}-->">
								</div>
							</div>
						</div>
						<div class="span3">
							<a class="btn btn-lime upload-card" style="display: none;" href="#">上传</a>卡密类产品 请上传卡密-不然会添加失败!
						</div>
					</div>

					<div class="row-fluid">
						<div class="span3">
							<div class="control-group">
								<label class="control-label">限购类型</label>
								<div class="controls">
									<!--{{form_radio('limit_type',-1,input_old('limit_type')==-1)}}-->限购一个
								</div>
							</div>
						</div>
						<div class="span3">
							<div class="control-group">
								<div class="controls">
									<!--{{form_radio('limit_type',0,input_old('limit_type')==0)}}-->不限购买
								</div>
							</div>
						</div>
						<div class="span3">
							<div class="control-group">
								<div class="controls">
									<!--{{form_radio('limit_type',1,input_old('limit_type')==1,{'id':'limit'})}}-->按规则限购
								</div>
							</div>
						</div>
					</div>

					<div class="control-group limit">
						<label class="control-label">限购规则设定</label>
						<div class="controls">
							<input name="limit[]" type="checkbox" id="mr-count" value="1" <!--{{ 1 in input_old('limit') ? 'checked' : '' }}-->/> 限制每人可购买总数
							<input type="text" data-rule-digits="true" class="validate[condRequired[mr-count]]"
							       data-msg-digits="请填写整数" data-rule-min="2" data-msg-min="总数至少为2"
							       name="single_limit" id="single-limit" style="width:50px" value="<!--{{ input_old('single_limit') }}-->"> 个
						</div>
					</div>
					<div class="row-fluid">
						<div class="span5 limit">
							<div class="control-group">
								<div class="controls">
									<input name="limit[]" type="checkbox" id="mt-count" value="2" <!--{{ 2 in input_old('limit') ? 'checked' : '' }}-->/> 限制每人每

									<input type="text" name="time_value" data-rule-digits="true" data-rule-min="1" data-msg-min="最小为1"
									       class="daily-limit-1 validate[condRequired[mt-count]]" data-msg-digits="请填写整数"
									       style="width:30px" value='<!--{{ input_old('time_value') }}-->'>
									<select name="time_type" style="width:80px" >
										<option value="day" <!--{{ input_old('time_type')=='day' ? 'selected' : '' }}-->>天</option>
										<option value="hour"  <!--{{ input_old('time_type')=='hour' ? 'selected' : '' }}-->>小时</option>
									</select>
								</div>
							</div>
						</div>
						<div class="span4 limit">
							<div class="control-group">
								<div class="controls">
									可购买数 <input type="text" name="rule_limit" data-rule-digits="true" data-rule-min="1" data-msg-min="最小为1" data-msg-digits="请填写整数"
									            class="daily-limit-2 validate[condRequired[mt-count]] input-small" value="<!--{{ input_old('rule_limit') }}-->" style="width:30px;"> 个
								</div>
							</div>
						</div>
					</div>

					<div class="control-group" id="gameRmb" >
						<label class="control-label">*游币价格</label>
						<div class="controls">
							<input type="text" name="discount_game_price"  class="input-large" value="<!--{{ input_old('discount_game_price') }}-->"
							       data-rule-required="true"  data-msg-required="请填写游币价格" data-rule-digits="true"  data-msg-digits="请填写整数" />(如果有优惠此处填写为折扣后的价格)
						</div>
					</div>

					

					<div class="row-fluid">
						<div class="span3">
							<div class="control-group">
								<label class="control-label">开启价格优惠</label>
								<div class="controls">
									<input id="if-discount" name="is_discount" data-on-color="success" data-on-text="优惠"
									       data-off-color="danger" data-off-text="无" class="switchbox" type="checkbox" <!--{{ input_old('is_discount') ? 'checked' : '' }}-->/>
								</div>
							</div>
						</div>
						<div class="span3">
							<div class="control-group discount-price">
								<label class="control-label">折扣</label>
								<div class="controls">
									<input type="text" id="dis-price" name="is_discount"  class="input-small validate[condRequired[if-discount]]" data-rule-digits="true" data-rule-min="1" data-rule-max="100" data-msg-min="最小为1" data-msg-max="最大为100" data-msg-digits="请填写整数"     value="<!--{{ input_old('is_discount') }}-->" />%
								</div>
							</div>
						</div>
					</div>

					<div class="control-group">
						<label class="control-label">限时优惠</label>
						<div class="controls">
							<input id="if-discount" name="product_display" data-on-color="success" data-on-text="优惠"
							       data-off-color="danger" data-off-text="无" class="switchbox" type="checkbox" <!--{{ input_old('product_display') ? 'checked' : '' }}-->/>
						</div>
					</div>


					
					<div class="control-group">
						<label class="control-label">是否置顶</label>
						<div class="controls">
							<input id="if-isTop" name="isTop" data-on-color="success" data-on-text="置顶"
							       data-off-color="danger" data-off-text="不置顶" class="switchbox" type="checkbox" <!--{{ input_old('isTop') ? 'checked' : '' }}-->/>
						</div>
					</div>
					<div class="control-group">
						<label class="control-label">是否上架</label>
						<div class="controls">
							<input id="isOnshelf" name="isOnshelf" data-on-color="success" data-on-text="上架"
							       data-off-color="danger" data-off-text="不上架" class="switchbox" type="checkbox" <!--{{ input_old('isOnshelf') ? 'checked' : '' }}-->/>
						</div>
					</div>
					<div class="row-fluid">
						<div class="span3">	
							<div class="control-group" id="product_sort" >
								<label class="control-label">商品排序</label>
								<div class="controls">
									<input type="text" name="product_sort"  class="input-small" value="<!--{{ input_old('porduct_sort') }}-->" />
								</div>
							</div>
						</div>
						<div class="span3">
							<div class="control-group">
								<label class="control-label">*库存总数</label>
								<div class="controls">
									<input type="text" id="product_stock" name="product_stock" data-rule-required="true" data-msg-required="请填写库存总数"  class="input-small"
									       value="<!--{{ input_old('product_stock') }}-->" />
								</div>
							</div>
						</div>
					</div>

					<div class="row-fluid">
						<div class="span3">
							<div class="control-group">
								<label class="control-label">列表小图</label>
								<div class="controls">
									<div class="fileupload fileupload-new" data-provides="fileupload">
										<div class="fileupload-new thumbnail" style="max-width: 120px; max-height: 120px;">
											<img src="/static/img/nopic.gif" />
										</div>
										<div class="fileupload-preview fileupload-exists thumbnail" style="max-width: 120px; max-height: 120px; line-height: 20px;"></div>
										<div>
											<span class="btn btn-file"><i class="icon-picture"></i><span class="fileupload-new">选择照片</span><span class="fileupload-exists">重新选择</span><input type="file" name='smallpic' /></span>
										</div>
									</div>
									<span class="help-inline">图片最佳尺寸:294*190</span>
								</div>
							</div>
						</div>
						<div class="span3">
							<div class="control-group">
								<label class="control-label">详情大图</label>
								<div class="controls">
									<div class="fileupload fileupload-new" data-provides="fileupload">
										<div class="fileupload-new thumbnail" style="max-width: 120px; max-height: 120px;">
											<img src="/static/img/nopic.gif" />
										</div>
										<div class="fileupload-preview fileupload-exists thumbnail" style="max-width: 120px; max-height: 120px; line-height: 20px;"></div>
										<div>
											<span class="btn btn-file"><i class="icon-picture"></i><span class="fileupload-new">选择照片</span><span class="fileupload-exists">重新选择</span><input type="file" name='bigpic' /></span>
										</div>
									</div>
									<span class="help-inline">图片最佳尺寸:640*334</span>
								</div>
							</div>
						</div>
					</div>
					
			       
			        <div class="control-group">
			            <label class="control-label">商品说明</label>
			            <div class="controls">
			                <textarea id="productSummary" name="productSummary" style="width:544px;height:200px;"><!--{{input_old('productSummary')}}--></textarea>
			            </div>
			        </div>
			        <div class="control-group">
			            <label class="control-label">商品描述</label>
			            <div class="controls">
			                <textarea id="productDesc" name="productDesc" style="width:544px;height:200px;"><!--{{input_old('productDesc')}}--></textarea>
			            </div>
			        </div>
			        <div class="control-group">
			            <label class="control-label">使用说明</label>
			            <div class="controls">
			            	<script id="productInstruction" name="productInstruction" type="text/plain"><!--{{ input_old('productInstruction') }}--></script>
			                
			            </div>
			        </div>
					<div class="row-fluid">
						<div class="span4">
							<div class="control-group">
								<label class="control-label">*开始时间</label>
								<div class="controls">
									<div class="input-append date">
										<input name="start_time" id="date_timepicker_start" type="text" class="input-medium " value="<!--{{ input_old('start_time') }}-->" data-rule-required="true"  data-msg-required="请填写开始时间"  readonly>
										<span class="add-on"><i class="icon-calendar"></i></span>
									</div>
								</div> 
							</div>
						</div>
						<div class="span4">
							<div class="control-group">
								<label class="control-label">*结束时间</label>
								<div class="controls">
									<div class="input-append date">
										<input name="end_time" id="date_timepicker_end" type="text" class="input-medium " value="<!--{{ input_old('end_time') }}-->" data-rule-required="true"  data-msg-required="请填写结束时间" readonly>
										<span class="add-on"><i class="icon-calendar"></i></span>
									</div>
								</div>
							</div>
						</div>
					</div>

					<div class="control-group" id="productPrice">
						<label class="control-label">是否发完自动下架</label>
						<div class="controls">
							<input id="discount" name="off_together" data-on-color="success" data-on-text="是" data-off-color="danger" data-off-text="否"
							       class="switchbox" type="checkbox" <!--{{ input_old('off_together') ? 'checked' : '' }}-->/>
						</div>
					</div>

					<div class="form-actions">
						<button type="submit" class="btn btn-primary"><i class="icon-ok"></i>保存</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>
<!--{%endblock%}-->
<!--{%block footer_js%}-->
<script src="/static/js/jquery.uniform.min.js"></script>
<script src="<!--{{asset('/static/js/xheditor/xheditor-1.1.14-zh-cn.min.js')}}-->"></script>
<script src="/static/js/jquery.validationEngine.js"></script>
<script src="/static/js/jquery.validationEngine-en.js"></script>
<script src="<!--{{asset('/static/js/ueditor/ueditorbbs.config.js')}}-->"></script>
<script src="<!--{{asset('/static/js/ueditor/ueditor.all.js')}}-->"></script>
<script src="/static/js/ajaxfileupload.js"></script>
<script>
	var set_selected_game=function(game_id,game_name,icon){
		$('#selected_game_id').val(game_id);
		$('#selected_game_name').val(game_name);
	};

	var set_selected_cate = function(cate_id,cate_name){
		$("#selected_categoryId").val(cate_id);
		$("#selected_cate_name").val(cate_name);
	};

	function type_fade(check_val){
		switch(check_val){
			case '0' :
				$('.taobao').fadeOut();
				$('.virtual').fadeIn();
				break;
			case '1' :
				$('.taobao').fadeOut();
				$('.virtual').fadeOut();
				break;
			case '2' :
				$('.taobao').fadeIn();
				$('.virtual').fadeOut();
		}
	}

	function limit_fade(check_val){
		switch(check_val){
			case '-1' :
			case '0' :
				$("input[name='limit[]']").removeClass('validate[minCheckbox[1]]');
				$('.limit').fadeOut();
				break;
			case '1' :
				$("input[name='limit[]']").addClass('validate[minCheckbox[1]]');
				$('.limit').fadeIn();
		}
	}

	$(function(){
		UE.getEditor('productInstruction');
		var d=new Date(),str=''; 
			str +=d.getFullYear()+'-'; //获取当前年份 
			str +=d.getMonth()+1+'-'; //获取当前月份（0——11） 
			str +=d.getDate(); 
			
			$("#exp_time").datetimepicker({});
			jQuery('#date_timepicker_start').datetimepicker({
  				format:'Y/m/d',
  				minDate:str,
  				onShow:function( ct ){
	   				this.setOptions({
	    			maxDate:jQuery('#date_timepicker_end').val()?jQuery('#date_timepicker_end').val():false
	   				})
  				},
  				timepicker:false,
  				onSelectDate:function(current_time,$input){ 
  					jQuery('#date_timepicker_end').datetimepicker({
  						format:'Y/m/d',
  						onShow:function( ct ){
					    	this.setOptions({
					    			minDate:$input.val()?$input.val():false
					    	})
  						},
  						timepicker:false
 					});
  				}
 			});
 			
		
	

		$('.switchbox').bootstrapSwitch();
		$('input').iCheck({
			checkboxClass: 'icheckbox_square-orange',
			radioClass: 'iradio_square-orange',
			increaseArea: '20%'
		});

		//种类
		type_fade($("input[name='product_type']:checked").val());
		$("input[name='product_type']").on('ifChecked',function(e){
			var check_val = e.currentTarget.value;
			type_fade(check_val);
		});
		
		//优惠
		if($("input[name='is_discount']:checked").val()){
			$(".discount-price").show();
		}else{
			$(".discount-price").hide();
		};
		$('#if-discount').on('switchChange.bootstrapSwitch', function (e, data) {
			if(data){
				$(".discount-price").fadeIn();
			}else{
				$(".discount-price").fadeOut();
			}
		});
		//置顶
		$('#if-isTop').on('switchChange.bootstrapSwitch', function (e, data) {
			e.preventDefault();
			if(data){
				$("#product_sort").fadeOut();
			}else{
				$("#product_sort").fadeIn();
			}
		});
		//限购
		limit_fade($("input[name='limit_type']:checked").val());
		$("input[name='limit_type']").on('ifChecked',function(e){
			var check_val = e.currentTarget.value;
			limit_fade(check_val);
		});

		$(document).on('change','#file_upload',function(){
			$.ajaxFileUpload({
				url:'/v4product/goods/ajax-check-file',
				type : 'post',
				fileElementId :'file_upload',
				dataType : 'JSON',
				success : function (data){
					data = eval("("+data+")");
					if(data.state){
						$(".card-line").text('已识别出'+data.line+'个卡密');
						$("#product_stock").val(data.line);
						$(".upload-card").show();
					}else{
						$(".upload-card").hide();
						alertify.error(data.msg);
					}
				},
				error : function(data,status,e){
					console.log(data);
				}
			})
		})

		$(document).on('click','.upload-card',function(){
			var expTimeStr=$("#expTimeStr").val();
			if(!expTimeStr){
				var file = $("#file_upload");
				alertify.error("请先填写卡密过期时间");
				file.after(file.clone().val(''));
				file.remove();
				return false;
			}
			var c_desc = $("input[name='product_name']").val();
			if(!c_desc){
				alertify.error("请先填写商品名称");
				return false;
			}
			alertify.confirm('确认上传该文件？',function(e){
				if(e){
					$.ajaxFileUpload({
						url:'/v4product/goods/import?exp=' + expTimeStr +'&c_desc=' + c_desc,
						type : 'post',
						secureuri :false,
						fileElementId :'file_upload',
						dataType : 'JSON',
						success : function (data){
							data = eval("("+data+")");
							if(data.state){
								$("#card-code").val(data.cardCode);
								alertify.success('上传成功');
							}else{
								alertify.error(data.msg);
							}
						}
					})
				}
			});
		})

		$('.select-pop-cate').on('click',function(){
			$.ajax({
				url:'/v4product/goods/cate-list-select',
				dataType:'json',
				success:function(json){
					var html = json.html;
					$.dialog({id:'pop-cate-list',title:'提示',padding:2,content:html,width:600,height:580});
				}
			});
		});

		$('.select-pop-game').bind('click',function(){
			$.ajax({
				url:'/game/api/game-search',
				dataType:'json',
				success:function(json){
					var html = json.html;
					$.dialog({id:'pop-game-list',title:'提示',padding:2,content:html,width:600,height:580});
				}
			});
		});

		//关联验证
		jQuery("#form-product").validationEngine({'custom_error_messages':{
			"minCheckbox":{
				'message':'<span style="left:240px;top:25px;color:#b94a48; position: absolute;width: 200px;">请至少选择一个规则</span>'
			},
			"#single-limit":{
				"condRequired": {'message':'<span style="color:#b94a48;left:220px;top:-20px;position:relative;width:100px;">请填写购买总数</span>'}
			},
			"#file_upload":{
				"condRequired": {'message':'<span style="color:#b94a48;position:absolute;width:100px;">请选择卡密文件</span>'}
			},
			"#tb-url":{
				"condRequired":{'message':'<span style="color: #b94a48;position:absolute;left:48px;width:100px;">请填写淘宝URL</span>'}
			},
			".daily-limit-1":{
				"condRequired": {'message':'<span style="color:#b94a48;left:240px;top:-20px;position:relative;width:100px;">请填写限制项</span>'}
			},
			".daily-limit-2":{
				"condRequired": {'message':'<span style="color:#b94a48;left:200px;top:-25px;position:relative;width:100px;">请填写限制项</span>'}
			},
			"#dis-price":{

				"condRequired": {'message':'<span style="color:#b94a48;position:absolute;left:50px;top:6px;width:120px;">请输入折扣</span>'}
			}
		}});
	});
</script>
<!--{%endblock%}-->