<!--{%extends "sub-layout-shop.twig"%}-->
<!--{%block main_content%}-->
<div class="row-fluid">
    <div class="span12">
		<div class="box">
			<div class="box-title">
				<h3><i class="icon-edit"></i>奖品设置</h3>
			</div>
			<div class="box-content">
					<form  id="form-product" action="<!--{{url('v4box/plan/prize-save')}}-->" method="POST" class='form-horizontal form-validate' enctype="multipart/form-data">
					<!--{% for key,data in datalist%}-->
					<div class="control-group">
                        <label class="control-label"><b>奖品<!--{{key}}--></b></label>
                        <div class="controls">
							<input type="hidden" name="id[<!--{{key}}-->]" value="<!--{{data.id}}-->">
							<input type="hidden" name="configId[<!--{{key}}-->]" value="<!--{{configId}}-->">
							<div class="control-group">
		                        <label class="control-label">奖品标题</label>
		                        <div class="controls">
		                            <input type="text" name="title[<!--{{key}}-->]"  class="input-xlarge" value="<!--{{data.title}}-->" />
		                        </div>
		                    </div>
							<div class="row-fluid">
								<div class="span3">
									<div class="control-group">
										<label class="control-label">奖品图片</label>
										<div class="controls">
											<div class="fileupload fileupload-new" data-provides="fileupload">
												<div class="fileupload-new thumbnail" style="max-width: 120px; max-height: 120px;">
													<img src="<!--{{ data.pic ? data.pic : '/static/img/nopic.gif' }}-->" />
												</div>
												<div class="fileupload-preview fileupload-exists thumbnail" style="max-width: 120px; max-height: 120px; line-height: 20px;"></div>
												<div>
													<span class="btn btn-file"><i class="icon-picture"></i><span class="fileupload-new">选择图片</span><span class="fileupload-exists">重新选择</span><input type="file" name='pic[<!--{{key}}-->]' /></span>
												</div>
											</div>
											<span class="help-inline" style="color: red" >图片最佳尺寸：400*290</span>
											<input type="hidden" name="old_pic[<!--{{key}}-->]" value="<!--{{ data.pic }}-->">
										</div>
									</div>
								</div>
							</div>
							<div class="control-group">
		                        <label class="control-label">中奖概率(%)</label>
		                        <div class="controls">
		                            <input type="text" name="chance[<!--{{key}}-->]"  class="input-xlarge chance" value="<!--{{data.chance}}-->" />
		                        </div>
		                    </div>
		                    <div class="control-group">
		                    	<label class="control-label">奖品类型</label>
		                        <div class="controls">
		                        	<select name="type[<!--{{key}}-->]" class="type">
		                            	<option value="3" <!--{% if data.type != '2' %}-->selected<!--{% endif %}--> >谢谢参与</option>
		                                <option value="2" <!--{% if data.type == '2' %}-->selected<!--{% endif %}--> >实物</option>
		                            </select>
		                        </div>
		                    </div>
							<div class="control-group count" <!--{% if data.type != '2' %}-->style="display: none;"<!--{% endif %}-->>
		                        <label class="control-label">奖品总数</label>
		                        <div class="controls">
		                            <input type="text" name="count[<!--{{key}}-->]"  class="input-xlarge" value="<!--{{data.count}}-->" />
		                        </div>
		                    </div>
							<div class="control-group kv" <!--{% if data.type != '2' %}-->style="display: none;"<!--{% endif %}-->>
					   		   <table class="table" id="input_params_table">
					    	    	<thead>
										<tr>
											<td>标题</td>
											<td>固定值</td>
											<td>
												<a class="add_input_param_button" pid="<!--{{key}}-->"><i class="icon-plus"></i></a>
											</td>
										</tr>
									</thead>
									<tbody id="tbody">
										<!--{% if data.model%}--> 
											<!--{% for k,v in data.model%}--> 
											    <tr id="edit">
											    	<td><input type="text" placeholder="必填" name="detailKey[<!--{{key}}-->][]" value="<!--{{v.key}}-->"></td>
			                                        <td><input type="text" placeholder="" name="detailValue[<!--{{key}}-->][]" value="<!--{{v.value}}-->"></td>
													<td>
														<a class="delete_param_button"><i class="icon-minus"></i></a> 
													</td>
												</tr>
											<!--{%endfor%}-->
										<!--{%endif%}-->
									</tbody>
							 	</table>
							</div>

                        </div>
                    </div>
					<!--{%endfor%}-->
					 <div class="form-actions">
						<button type="submit" class="btn btn-primary sub"><i class="icon-ok"></i>保存</button>
					</div>    
				</form>	
			</div>   
		</div>
    </div>
</div>			
<!--{%endblock%}-->

<!--{%block footer_js%}-->
<script id="tpl_input_param" type="text/html">
	
</script>
<script>
$(function(){
	function getOutTpl(){
        var html = template.render('tpl_out_param');
        return html;
    }
    
    function getErrorTpl(){
        var html = template.render('tpl_error_param');
        return html;
    }


	//种类
	$(".type").change('ifChecked',function(e){
		var check_val = e.currentTarget.value;
		switch(check_val){
			case '2' :
				$(this).parent().parent().parent().find('.count').fadeIn();
				$(this).parent().parent().parent().find('.kv').fadeIn();
				break;
			case '3' :
				$(this).parent().parent().parent().find('.count').fadeOut();
				$(this).parent().parent().parent().find('.kv').fadeOut();
				break;
		}
		return false;
	});

    $("table td a").click(function() {
        var row = $(this).parents("tr");
        if ($(this).hasClass("delete_param_button")) {
            //var ids_del = $("#ids_del").val();
            //$("#ids_del").val(ids_del+row.children('.del').val()+',');
            row.remove();
        }else{
            var table = $(this).parents("table");
            var pid = $(this).attr('pid');
            if($(this).hasClass("add_input_param_button")){
                addAfterTableRow(this,getInputTpl,pid);
            }else if($(this).hasClass("add_out_param_button")){
                addAfterTableRow(this,getOutTpl,pid);
            }else if($(this).hasClass("add_error_param_button")){
                addAfterTableRow(this,getErrorTpl,pid);
            }
        }

    });

});

$(".sub").click(function() {
	var chance_all = 0;
	chance_all = Number(chance_all);
 	$(".chance").each(function() {
		chance_all = chance_all + Number($(this).val());
	});
	if (chance_all != 100) {
		alert("奖品概率总和不为100%！");
		return false;
	}
});
    
function getInputTpl(pid){
		i=0;
		var html =new Array();
        	html['0']="<tr id='add_"+i+"'>";
        	html['1']="<td><input type='text' placeholder='必填' name='detailKey["+pid+"][]' value='' /></td>";
            html['2']="<td><input type='text' placeholder='' name='detailValue["+pid+"][]' value=''></td>";
			html['3']="<td><a class='delete_param_button'><i class='icon-minus'></i></a> </td>";
			html['4']="</tr>";
		return html.join('');
}


function addAfterTableRow(a, rowStringFunc, pid){
	var row = $(a).parents("tr");
	//row.appendTo(table.find("tbody"));
	var table = $(a).parents("table");
	row.after(rowStringFunc(pid));
	row.next().find("a").click(function() {
		if($(this).hasClass('delete_param_button')){
			deleteTableRow($(this).parent().parent());
		}else if($(this).hasClass('add_input_param_button') || $(this).hasClass('add_out_param_button') || $(this).hasClass('add_error_param_button')){
			addAfterTableRow(this,rowStringFunc, pid)
		}
	});
	return row
}

function deleteTableRow(row) {
	row.remove();
}

</script>
<!--{%endblock%}-->
