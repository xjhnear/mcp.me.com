<!--{%extends "base-layout.twig"%}-->
<!--{%block main_content%}-->
<div class="row-fluid">
	<div class="span12">
	    <div class="box box-color box-bordered">
			<div class="box-title">
				<h3>
					<i class="icon-table"></i>
					批次管理
					<span class="badge badge-warning"><!--{{totalcount}}--></span>
				</h3>
				<div class="actions">
				    <form action="<!--{{url('phone/batch/list')}}-->" class="">
				    <table class="table-filter">				        
				        <tr>
				            <td><input name="batch_code" type="text" class="input-small" value="<!--{{search.batch_code}}-->" /></td>
				            <td><button class="btn btn-teal"><i class="icon-search"></i>搜索</button></td>
				            <!--<td><a href="<!--{{url('phone/batch/add')}}-->" class="btn btn-teal">添加批次</a></td>-->
							<td><a class="btn btn-teal ajax-append" href="javascript:void(0);">添加批次</a></td>
				        </tr>
				    </table>
				    </form>
				</div>
			</div>
			<div class="box-content nopadding">
			    <table class="table table-hover table-nomargin">
			        <thead>
						<tr>
						    <th class="col-40">
						        
							</th>
						    <th class="col-50">ID</th>
							<th class="col-150">批次Code</th>
							<th class="col-150">数量</th>
							<th class="col-150">创建时间</th>
							<th class="col-150">修改时间</th>
							<th class="table-btn-group">操作</th>
						</tr>
					</thead>
					<tbody>
					<!--{%for item in datalist%}-->
					<tr>
						<td></td>
						<td><!--{{item.batch_id}}--></td>
						<td><!--{{item.batch_code}}--></td>
						<td><!--{{item.count}}--></td>
						<td><!--{{item.created_at|date('Y-m-d H:i:s')}}--></td>
						<td><!--{{item.updated_at|date('Y-m-d H:i:s')}}--></td>
						<td>
							<a href="<!--{{url('phone/batch/edit',{'admin_id':item.batch_id})}}-->" class="btn btn-primary">编辑</a>
							<a href="<!--{{url('phone/batch/del',{'admin_id':item.batch_id})}}-->" class="btn btn-danger">删除</a>
							<a class="btn btn-teal ajax-down" batch_id="<!--{{item.batch_id}}-->" href="javascript:void(0);">导出</a>
						</td>
					</tr>
					<!--{%endfor%}-->
					</tbody>
			    </table>
			    <div class="pagelink">
			        <!--{{pagelinks}}-->
			    </div>
			</div>
		</div>
	</div>
</div>

<!-- 模态框（Modal） -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<!--榜单导入-->
	<div id="dialog-append">
		<div class="box-content">
			<div class="control-group">
				<label class="control-label">批次Code</label>
				<div class="controls">
					<input type="text" name="batch_code" class="input-large" value="" />
				</div>
			</div>
			<div class="control-group">
				<input type="hidden" name="tmp" id="tmp" value="">
				<input type="hidden" name="filename" id="filename" value="">
				<label class="control-label">批次文件</label>
				<div class="controls">
					<input name="append_file" id="file_upload" type="file">
					<a href="javascript:void(0);" class="btn btn-primary append_">确定</a>
					<p class="text-error card-line"></p>
				</div>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="myModal2" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<!--榜单导入-->
	<div id="dialog-down">
		<div class="box-content">
			<div class="control-group">
				<label class="control-label">每个文件数据条数</label>
				<div class="controls">
					<input type="text" name="pageSize" class="input-large" value="" />
				</div>
			</div>
			<div class="control-group">
				<div class="controls">
					<a href="javascript:void(0);" class="btn btn-primary down_">确定</a>
					<p class="text-error card-line"></p>
				</div>
			</div>
		</div>
	</div>
</div>
<!-- 模态框（Modal） -->

<!--{%endblock%}-->

<!--{%block footer_js%}-->
<script src="/static/js/laydate/laydate.js"></script>
<script src="<!--{{asset('/static/js/ajaxfileupload.js')}}-->"></script>
<script>
	$(function(){
		$(".ajax-append").bind('click',function(){
			var html=$("#dialog-append").html();
			$.dialog({id:'pop-daoru-html',title:'提示',padding:2,content:html,width:410,height:120});
			var can_up = true;
			$("a.append_").bind('click',function(){
				alertify.confirm('确认上传该文件？',function(e){
					if(e && can_up){
						var batch_code =  $("input[name='batch_code']").val();
						can_up = false;
						$.ajaxFileUpload({
							url:'/phone/batch/ajax-upload-file?batch_code='+batch_code,
							type : 'post',
							secureuri :false,
							fileElementId :'file_upload',
							dataType : 'JSON',
							success : function (data){
								can_up = true;
								data = eval("("+data+")");
								if(data.state){
									alertify.success(data.msg);
									setTimeout(function(){location.reload();},1000);
								}else{
									alertify.error(data.msg);
								}
							}
						})
					}
				});
			});
		});

		$(".ajax-down").bind('click',function(){
			var obj = $(this);
			var html=$("#dialog-down").html();
			$.dialog({id:'pop-daochu-html',title:'提示',padding:2,content:html,width:410,height:120});
			$("a.down_").bind('click',function(){
				var batch_id = obj.attr('batch_id');
				var pageSize =  $("input[name='pageSize']").val();
				$.ajax({
					url:'/phone/batch/ajax-down-file',
					type : 'post',
					data:{batch_id: batch_id,pageSize: pageSize},
					dataType : 'JSON',
					success : function (data){
						if(data.state){
							document.location.href =(data.url);
							setTimeout(function(){location.reload();},1000);
						}else{
							alertify.error(data.msg);
						}
					}
				})

			});

		});
	});
</script>
<!--{%endblock%}-->